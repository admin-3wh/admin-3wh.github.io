<!-- projects/shapesound/index.html -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ShapeSound</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body class="dark">
  <div id="app">
    <header id="top-bar">
      <h1>ShapeSound</h1>
      <button id="theme-toggle">üåô Dark</button>
    </header>

    <!-- Natural Prompt Box -->
    <div id="prompt-box">
      <input
        type="text"
        id="natural-prompt"
        placeholder="Describe your scene (e.g., 'turtle crawling with slow notes' or '4 white squares')"
      />
      <button id="convert-prompt">Generate</button>
    </div>

    <!-- Script Editor -->
    <textarea id="code" placeholder="Write your ShapeSound script here..."></textarea>

    <!-- Controls -->
    <div id="controls">
      <button id="run">Run</button>
      <button id="help-toggle">‚ùì Help</button>
      <button id="save-json">Export JSON</button>
      <input type="file" id="load-json" accept=".json" style="display:none;" />
      <label for="load-json" class="button-like">Import JSON</label>

      <select id="example-picker">
        <option value="">Load Example</option>
        <option value="example1">Rainbow Circle</option>
        <option value="example2">Line Dance</option>
        <option value="example3">Turtle Crawl (tempo + sequence)</option>
      </select>

      <select id="saved-scenes"></select>
      <button id="save-scene">Save</button>
      <button id="delete-scene">Delete</button>

      <button id="export-png">Export PNG</button>
      <button id="copy-code">Copy Code</button>
    </div>

    <!-- Timeline Controls -->
    <div id="timeline-controls">
      <button id="play-scene">‚ñ∂ Play</button>
      <button id="pause-scene">‚è∏ Pause</button>
      <button id="resume-scene">‚èØ Resume</button>
      <input type="range" id="timeline-scrubber" min="0" max="100" value="0" />
    </div>

    <!-- Error Box -->
    <div id="error-box" style="display:none;"></div>

    <!-- Canvas -->
    <canvas id="canvas" width="800" height="600"></canvas>

    <!-- Help Panel -->
    <div id="help-panel" style="display: none;">
      <h3>ShapeSound Help</h3>
      <pre>
canvas 800 600
background #000000
tempo 100  <!-- beats per minute; affects 'play' and 'sequence' -->

circle 400 300 50 color #FF0000
rect 100 100 100 100 color #00FF00
line 100 100 300 300 width 5 color #FFFFFF

sound 440 1
play C4
sequence {
  C4 D4 E4 F4
}

sprite turtle crawling x=100 y=520 scale=1

animate sprite turtle 100 520 1 -> 700 520 1 duration 8s
animate circle 300 300 30 -> 500 300 80 duration 5s fromColor #FF0000 toColor #00FF00
delay 1000
      </pre>
    </div>
  </div>

  <!-- Bridge: import engine, normalize API, expose readiness -->
  <script type="module">
    function normalizeAPI(mod) {
      let api = mod?.default ?? mod ?? {};
      // If default is a class/ctor, try to instantiate (best-effort)
      try {
        if (typeof api === 'function' && !('loadFromText' in api) && !('run' in api)) {
          api = new api(); // ignore if it throws
        }
      } catch {}
      // If engine already published a global, prefer that
      if (window.ShapeSound && typeof window.ShapeSound === 'object') {
        api = { ...api, ...window.ShapeSound };
      }
      return {
        loadFromText: api.loadFromText || api.load || api.parseAndRun || api.run || null,
        play:         api.play || api.start || null,
        pause:        api.pause || null,
        resume:       api.resume || api.unpause || null,
        seek:         api.seek || null,
        render:       api.render || api.renderInitial || null,
        _raw:         api,
      };
    }

    async function initBridge() {
      const cacheBust = `?v=${Date.now()}`;
      try {
        const mod = await import('./shapesound.js' + cacheBust);
        const api = normalizeAPI(mod);
        window.ShapeSound = api;
        console.log('[ShapeSound] Bridge ready; exports:', Object.keys(api._raw || {}));
      } catch (err) {
        console.error('[ShapeSound] Failed to import ./shapesound.js', err);
        // Surface the reason in the UI if the error box exists
        const box = document.getElementById('error-box');
        if (box) {
          box.style.display = 'block';
          box.style.color = 'orangered';
          box.textContent = 'Engine bridge failed to initialize: ' + (err?.message || err);
        }
        throw err;
      }
    }
    window.ShapeSoundReady = initBridge();
  </script>

  <!-- TF.js (must be before TinyGPT) -->
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.18.0/dist/tf.min.js"></script>

  <!-- TinyGPT loader (cache-busted) -->
  <script src="tinygpt.js?v=10"></script>

  <!-- UI wiring -->
  <script>
    const $ = (s) => document.querySelector(s);
    const codeArea = $('#code');
    const statusEl = $('#error-box');

    function setStatus(msg, ok=false) {
      statusEl.style.display = 'block';
      statusEl.style.color = ok ? 'limegreen' : 'orange';
      statusEl.textContent = msg;
      if (ok) setTimeout(() => (statusEl.style.display = 'none'), 1200);
    }

    // Generate via TinyGPT
    $('#convert-prompt')?.addEventListener('click', async () => {
      const input = $('#natural-prompt').value;
      setStatus('Thinking with TinyGPT‚Ä¶');
      try {
        const dsl = await window.TinyGPT.promptToSceneDSL(input);
        codeArea.value = dsl;
        setStatus('Generated!', true);
      } catch (e) {
        console.error(e);
        setStatus('AI generation failed. Check console.');
      }
    });

    // Load + render current DSL
    async function loadAndRender() {
      try { await window.ShapeSoundReady; } catch { setStatus('Engine bridge failed to initialize.'); return; }
      const eng = window.ShapeSound;
      if (!eng) { setStatus('Engine bridge not ready.'); return; }

      const code = codeArea.value || '';
      try {
        if (typeof eng.loadFromText === 'function')           await eng.loadFromText(code);
        else if (typeof eng._raw?.run === 'function')         await eng._raw.run(code);
        else if (typeof eng._raw?.parseAndRun === 'function') await eng._raw.parseAndRun(code);
        else throw new Error('No load/run method found on ShapeSound');

        if (typeof eng.render === 'function') eng.render();
        else if (typeof eng._raw?.renderInitial === 'function') eng._raw.renderInitial();

        setStatus('Ready.', true);
      } catch (e) {
        console.error('[ShapeSound] load/run error', e);
        setStatus('Could not load scene. See console.');
      }
    }

    $('#run')?.addEventListener('click', loadAndRender);
    $('#play-scene')?.addEventListener('click', async () => { try { await window.ShapeSoundReady; window.ShapeSound?.play?.(); } catch(e){ console.error(e); } });
    $('#pause-scene')?.addEventListener('click', async () => { try { await window.ShapeSoundReady; window.ShapeSound?.pause?.(); } catch(e){ console.error(e); } });
    $('#resume-scene')?.addEventListener('click', async () => { try { await window.ShapeSoundReady; window.ShapeSound?.resume?.(); } catch(e){ console.error(e); } });

    // Theme Toggle
    const themeToggle = document.getElementById("theme-toggle");
    const body = document.body;
    if (localStorage.getItem("theme")) {
      body.className = localStorage.getItem("theme");
      themeToggle.textContent = body.classList.contains("dark") ? "üåô Dark" : "‚òÄÔ∏è Light";
    }
    themeToggle.addEventListener("click", () => {
      body.classList.toggle("dark");
      body.classList.toggle("light");
      const theme = body.classList.contains("dark") ? "dark" : "light";
      themeToggle.textContent = theme === "dark" ? "üåô Dark" : "‚òÄÔ∏è Light";
      localStorage.setItem("theme", theme);
    });
  </script>
</body>
</html>
