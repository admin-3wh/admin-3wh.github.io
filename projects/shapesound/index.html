<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>ShapeSound</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root {
      --bg: #0b0f1a;
      --panel: #121826;
      --panel-2: #0f1422;
      --text: #e7ebf3;
      --muted: #98a2b3;
      --accent: #7c5cff;
      --btn: #1f2a44;
      --btn-hover: #2a3656;
      --error: #ff4d6d;
      --ok: #2dd4bf;
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0;
      background: linear-gradient(120deg, #0b0f1a, #0b1222 60%, #0a1530);
      color: var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Inter, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
    }

    header {
      padding: 16px 20px;
      border-bottom: 1px solid #1a2237;
      background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0));
      display: flex;
      align-items: center;
      gap: 14px;
    }
    header h1 {
      font-size: 18px;
      margin: 0;
      letter-spacing: 0.4px;
      font-weight: 600;
    }
    header .sub {
      color: var(--muted);
      font-size: 12px;
    }

    .wrap {
      display: grid;
      grid-template-columns: 1fr 380px;
      gap: 16px;
      padding: 16px;
    }
    @media (max-width: 960px) {
      .wrap { grid-template-columns: 1fr; }
    }

    /* Canvas area */
    .stage {
      background: var(--panel);
      border: 1px solid #1b2440;
      border-radius: 12px;
      padding: 12px;
      display: grid;
      gap: 12px;
    }
    .canvas-frame {
      display: grid;
      place-items: center;
      background: var(--panel-2);
      border: 1px solid #1b2440;
      border-radius: 10px;
      padding: 8px;
      min-height: 300px;
    }
    canvas {
      width: 800px;
      height: 600px;
      max-width: 100%;
      background: #000;
      border-radius: 8px;
      image-rendering: crisp-edges;
    }

    .toolbar {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
      justify-content: space-between;
    }
    .left-controls, .right-controls {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
    }
    button, select, input[type="range"], input[type="number"], input[type="text"] {
      background: var(--btn);
      color: var(--text);
      border: 1px solid #243055;
      border-radius: 8px;
      padding: 8px 10px;
      font-size: 13px;
    }
    input[type="number"], input[type="text"] { width: 100%; }
    button:hover { background: var(--btn-hover); cursor: pointer; }
    button.primary {
      background: var(--accent);
      border-color: #6c4bff;
      color: white;
    }
    button.primary:hover { filter: brightness(1.05); }

    .scrubber {
      display: grid;
      grid-template-columns: 1fr auto;
      gap: 10px;
      align-items: center;
      padding: 8px 10px;
      background: #0e1830;
      border: 1px solid #1b2440;
      border-radius: 10px;
    }
    #timeline-scrubber { width: 100%; accent-color: var(--accent); }

    .error {
      display: none;
      background: #2a1020;
      border: 1px solid #522;
      color: #ffd9e1;
      padding: 10px 12px;
      border-radius: 8px;
      font-size: 13px;
    }

    /* Control panel */
    .panel {
      background: var(--panel);
      border: 1px solid #1b2440;
      border-radius: 12px;
      padding: 12px;
      display: grid;
      gap: 12px;
      position: relative;
    }
    .panel h2 {
      font-size: 14px;
      margin: 0 0 4px;
      color: var(--muted);
      letter-spacing: 0.3px;
      font-weight: 600;
    }
    textarea {
      width: 100%;
      min-height: 180px;
      resize: vertical;
      background: #0f172a;
      color: #e6ecff;
      border: 1px solid #1e294a;
      border-radius: 8px;
      padding: 10px;
      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;
      font-size: 12px;
      line-height: 1.45;
    }
    .grid { display: grid; gap: 10px; }
    .row { display: grid; gap: 8px; }
    .row.inline { grid-template-columns: 1fr auto auto; align-items: center; }

    .help {
      background: #0e1630;
      border: 1px dashed #28345e;
      border-radius: 10px;
      padding: 10px;
      color: #c9d2ee;
      font-size: 12px;
    }
    .muted { color: var(--muted); }
    .footer-note { color: var(--muted); font-size: 12px; text-align: center; padding: 6px 0 2px; }
    a { color: var(--ok); text-decoration: none; }
    a:hover { text-decoration: underline; }

    /* Small audio meter */
    .meter {
      height: 10px;
      border-radius: 6px;
      background: #0c1230;
      border: 1px solid #1b2440;
      overflow: hidden;
      position: relative;
    }
    .meter .bar {
      height: 100%;
      width: 0%;
      background: linear-gradient(90deg, #2dd4bf, #7c5cff);
      transition: width 80ms linear;
    }
    .mini-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
    .mini-grid-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; }
  </style>
</head>
<body>
  <header>
    <h1>ShapeSound</h1>
    <div class="sub">Draw • Animate • Play Notes</div>
  </header>

  <main class="wrap">
    <!-- Left: Canvas/Playback -->
    <section class="stage">
      <div class="canvas-frame">
        <canvas id="canvas" width="800" height="600"></canvas>
      </div>

      <div class="toolbar">
        <div class="left-controls">
          <button id="run" class="primary">Run Scene</button>
          <button id="play-scene">Play</button>
          <button id="pause-scene">Pause</button>
          <button id="resume-scene">Resume</button>
        </div>
        <div class="right-controls">
          <button id="export-png" title="Download a PNG of the current canvas">Export PNG</button>
        </div>
      </div>

      <div class="scrubber">
        <input id="timeline-scrubber" type="range" min="0" max="100" value="0" />
        <div class="muted" style="font-size:12px;">timeline</div>
      </div>

      <div id="error-box" class="error">Parse error will appear here.</div>
    </section>

    <!-- Right: Controls/Editor -->
    <aside class="panel">
      <div class="grid">
        <div class="row">
          <h2>Natural Prompt → DSL</h2>
          <div class="row inline">
            <input id="natural-prompt" type="text" placeholder="e.g. neon blobs drifting left to right, slow, seed 42" style="background:#0f172a;border:1px solid #1e294a;border-radius:8px;padding:8px;color:#e6ecff;">
            <button id="convert-prompt">Convert</button>
            <button id="help-toggle" title="Toggle help">Help</button>
          </div>
          <div id="help-panel" class="help" style="display:none">
            <div><strong>Quick DSL</strong></div>
            <pre style="white-space:pre-wrap;margin:6px 0 0;">
canvas 800 600
background #000000
backgroundnoise 1.2 0.18 color #0b1022 #1c2a4a
tempo 100
blob 200 300 50 18 18 color #13F1FF id=b1 speed 0.3
star 400 300 70 28 7 color #FFD84A id=s1 rot 15
poly 600 300 60 6 color #FF00FF id=p1 rot 10
wiggle b1 6 6 0.3
field noise id=f1 scale 0.006 speed 0.22 strength 35
behavior b1 use f1 mix 0.8
animate sprite b1 20 120 1 -> 780 120 1 duration 8s ease in-out
            </pre>
          </div>
        </div>

        <div class="row">
          <h2>Examples</h2>
          <select id="example-picker">
            <option value="">Select an example…</option>
            <option value="example1">Flowy neon blobs</option>
            <option value="example2">Polys + star with field</option>
            <option value="example3">Turtle walk + sequence</option>
            <!-- NEW demo entries handled in-page -->
            <option value="example4">Physics: gravity + bounces</option>
            <option value="example5">Field flow + drifting polys</option>
          </select>
        </div>

        <div class="row">
          <h2>Scene Code</h2>
          <textarea id="code" spellcheck="false">canvas 800 600
backgroundnoise 1.2 0.18 color #0b1022 #1c2a4a
tempo 100
blob 200 300 50 18 18 color #13F1FF id=b1 speed 0.28
blob 400 300 56 20 22 color #00E1B4 id=b2 speed 0.28
blob 600 300 44 16 16 color #FF3CAC id=b3 speed 0.28
wiggle b1 6 4 0.35
wiggle b2 8 6 0.25
wiggle b3 5 7 0.30
field noise id=f1 scale 0.006 speed 0.22 strength 35
behavior b1 use f1 mix 0.8
behavior b2 use f1 mix 0.8
behavior b3 use f1 mix 0.8</textarea>
          <div class="row" style="grid-template-columns: repeat(2,1fr); gap:8px;">
            <button id="copy-code">Copy Code</button>
            <button id="run2" class="primary">Run Scene</button>
          </div>
        </div>

        <!-- NEW: Audio controls -->
        <div class="row">
          <h2>Audio</h2>
          <div class="mini-grid">
            <button id="init-audio" title="Resume / init the shared AudioContext">Init/Resume Audio</button>
            <div>
              <div class="muted" style="font-size:12px;margin-bottom:4px;">Volume</div>
              <input id="volume" type="range" min="0" max="1" step="0.01" value="1" style="width:100%; accent-color: var(--accent);" />
            </div>
          </div>
          <div class="muted" style="font-size:12px;">Output Level</div>
          <div class="meter"><div id="meter-bar" class="bar"></div></div>
        </div>

        <!-- NEW: Physics controls -->
        <div class="row">
          <h2>Physics</h2>
          <div class="mini-grid-3">
            <button id="physics-on">Enable</button>
            <button id="physics-off">Disable</button>
            <select id="bounds">
              <option value="none">Bounds: none</option>
              <option value="canvas">Bounds: canvas</option>
            </select>
          </div>
          <div class="mini-grid">
            <div>
              <div class="muted" style="font-size:12px;margin-bottom:4px;">Gravity X</div>
              <input id="grav-x" type="number" step="1" value="0">
            </div>
            <div>
              <div class="muted" style="font-size:12px;margin-bottom:4px;">Gravity Y</div>
              <input id="grav-y" type="number" step="1" value="0">
            </div>
          </div>
          <div>
            <div class="muted" style="font-size:12px;margin-bottom:4px;">Damping (0.90–1.00+)</div>
            <input id="damping" type="number" step="0.01" value="1.0">
          </div>
          <div class="mini-grid">
            <div>
              <div class="muted" style="font-size:12px;margin-bottom:4px;">Sprite Id</div>
              <input id="sprite-id" type="text" placeholder="e.g. b1">
            </div>
            <div>
              <div class="muted" style="font-size:12px;margin-bottom:4px;">Impulse (ix, iy)</div>
              <div class="mini-grid">
                <input id="imp-x" type="number" step="1" value="120">
                <input id="imp-y" type="number" step="1" value="-60">
              </div>
            </div>
          </div>
          <div class="mini-grid">
            <button id="apply-gravity">Apply Gravity/Damping/Bounds</button>
            <button id="apply-impulse">Apply Impulse</button>
          </div>
          <div class="mini-grid">
            <div>
              <div class="muted" style="font-size:12px;margin-bottom:4px;">Set Velocity (vx, vy)</div>
              <div class="mini-grid">
                <input id="vel-x" type="number" step="1" value="0">
                <input id="vel-y" type="number" step="1" value="0">
              </div>
            </div>
            <button id="apply-vel" style="align-self:end;">Set Velocity</button>
          </div>
        </div>

        <div class="footer-note">
          Pro-tip: Click <em>Convert</em> to turn a natural prompt into DSL. Then hit <em>Run Scene</em>.
        </div>
      </div>
    </aside>
  </main>

  <!-- Optional TinyGPT (exposes window.TinyGPT). Keep before shapesound.js if you use it. -->
  <!-- <script src="tinygpt.js"></script> -->

  <!-- Your engine -->
  <script type="module" src="shapesound.js"></script>

  <!-- Wire extra UI to ShapeSound.hooks and extend examples -->
  <script>
    // Secondary Run button (the top one is already wired by shapesound.js)
    document.getElementById('run2')?.addEventListener('click', () => {
      const code = document.getElementById('code')?.value || '';
      window.ShapeSound?.loadFromText(code);
    });

    // Extend the example picker for two extra demos (example4, example5).
    // shapesound.js already handles example1..3 — this handler only intercepts 4 & 5.
    document.getElementById('example-picker')?.addEventListener('change', (e) => {
      const val = e.target.value;
      if (!val) return;

      const extras = {
        example4: `canvas 800 600
background #0b1022
tempo 90
// three bouncing circles (as live sprites via ids)
circle 200 120 28 color #13F1FF id=c1
circle 400 180 28 color #FAFF00 id=c2
circle 600 140 28 color #FF3CAC id=c3
physics on
bounds canvas
gravity 0 180
damping 0.995
setvel c1 60 -40
setvel c2 -40 -20
setvel c3 80 -70
sequence { C4 E4 G4 C5 }`,

        example5: `canvas 800 600
backgroundnoise 1.2 0.16 color #0b1022 #1c2a4a
tempo 110
// drifting polys under a smooth flow field + path drift
poly 180 300 60 6 color #4CC9F0 id=p1 rot 10
poly 400 300 55 5 color #F72585 id=p2 rot -6
poly 620 300 52 7 color #4361EE id=p3 rot 12
field noise id=f1 scale 0.006 speed 0.22 strength 34
behavior p1 use f1 mix 0.8
behavior p2 use f1 mix 0.8
behavior p3 use f1 mix 0.8
animate sprite p1 20 180 1 -> 780 180 1 duration 9s ease in-out
animate sprite p2 20 300 1 -> 780 300 1 duration 9s ease in-out
animate sprite p3 20 420 1 -> 780 420 1 duration 9s ease in-out
sequence { C4 D4 E4 G4 }`
      };

      if (extras[val]) {
        const area = document.getElementById('code');
        if (area) area.value = extras[val];
      }
      // If user selects example1..3, shapesound.js' built-in handler will populate the code.
    });

    // Audio: init/resume + volume + meter
    const vol = document.getElementById('volume');
    const meterBar = document.getElementById('meter-bar');
    let meterRAF = null;

    function startMeter() {
      cancelAnimationFrame(meterRAF);
      const hooks = window.ShapeSound?.hooks;
      if (!hooks) return;

      const tick = () => {
        const lv = hooks.getLevels?.();
        if (lv && typeof lv.rms === 'number') {
          const pct = Math.max(0, Math.min(1, lv.rms * 3)) * 100; // modest gain
          meterBar.style.width = pct.toFixed(1) + '%';
        }
        meterRAF = requestAnimationFrame(tick);
      };
      meterRAF = requestAnimationFrame(tick);
    }

    document.getElementById('init-audio')?.addEventListener('click', () => {
      try {
        // Prefer the explicit API added in shapesound.js
        window.ShapeSound?.initAudio();
      } catch (e) {
        // Fallback: force-create AC via hooks if needed
        try { window.ShapeSound?.hooks?.getAC?.(); } catch(_) {}
      }
      startMeter();
    });

    vol?.addEventListener('input', (e) => {
      const v = parseFloat(e.target.value);
      window.ShapeSound?.hooks?.setMasterVolume?.(isFinite(v) ? v : 1);
    });

    // Physics controls
    const hooks = () => window.ShapeSound?.hooks;
    document.getElementById('physics-on')?.addEventListener('click', () => hooks()?.setPhysics(true));
    document.getElementById('physics-off')?.addEventListener('click', () => hooks()?.setPhysics(false));

    document.getElementById('apply-gravity')?.addEventListener('click', () => {
      const gx = parseFloat(document.getElementById('grav-x')?.value);
      const gy = parseFloat(document.getElementById('grav-y')?.value);
      const d  = parseFloat(document.getElementById('damping')?.value);
      const b  = document.getElementById('bounds')?.value;
      hooks()?.setGravity(isFinite(gx)?gx:0, isFinite(gy)?gy:0);
      hooks()?.setDamping(isFinite(d)?d:1);
      hooks()?.setBounds(b === 'canvas' ? 'canvas' : 'none');
    });

    document.getElementById('apply-impulse')?.addEventListener('click', () => {
      const id = (document.getElementById('sprite-id')?.value || '').trim();
      const ix = parseFloat(document.getElementById('imp-x')?.value);
      const iy = parseFloat(document.getElementById('imp-y')?.value);
      if (id) hooks()?.impulse(id, isFinite(ix)?ix:0, isFinite(iy)?iy:0);
    });

    document.getElementById('apply-vel')?.addEventListener('click', () => {
      const id = (document.getElementById('sprite-id')?.value || '').trim();
      const vx = parseFloat(document.getElementById('vel-x')?.value);
      const vy = parseFloat(document.getElementById('vel-y')?.value);
      if (id) hooks()?.setVel(id, isFinite(vx)?vx:0, isFinite(vy)?vy:0);
    });

    // Kick the meter once the page is interacted with (optional)
    window.addEventListener('click', () => { startMeter(); }, { once: true, passive: true });
  </script>
</body>
</html>
